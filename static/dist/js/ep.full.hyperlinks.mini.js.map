{"version":3,"sources":["validUrl.js","copyPasteEvents.js","linkBoxes.js","newLink.js","preLinkMark.js","shared.js"],"names":["exports","moduleList","randomString","require","_","validUrl","splitUri","uri","match","is_iri","value","test","splitted","scheme","authority","path","query","fragment","out","length","toLowerCase","is_http_iri","allowHttps","port","replace","is_https_iri","is_web_iri","is_uri","is_http_uri","is_https_uri","is_web_uri","isUri","isHttpUri","isHttpsUri","isWebUri","events","replaceLinkIdsWithFakeIds","linksData","html","linkIdToFakeId","each","link","fakeLinkId","linkId","data","originalLinkId","buildLinkIdToFakeIdMap","$","find","removeClass","addClass","getHtml","buildLinksData","links","originalLinkIds","getLinkIds","generateFakeLinkId","allSpans","linkIds","span","cls","attr","classLinkId","exec","push","uniq","createHiddenDiv","range","content","cloneContents","div","document","createElement","hiddenDiv","selectionHasOnlyText","rawHtml","htmlDecode","text","buildHtmlToCopyWhenSelectionHasOnlyText","htmlWithSpans","buildHtmlWithTwoSpanTags","buildHtmlWithFormattingTagsOfSelection","parseHTML","htmlOfParentNode","commonAncestorContainer","parentNode","tags","getTagsInSelection","buildOpenTags","buildCloseTags","slice","openTags","forEach","tag","closeTags","reverse","htmlObject","hasOwnProperty","localName","prop","stylingTagRegex","parent","saveLink","linksToSave","padId","clientVars","mapOriginalLinksId","pad","plugins","ep_full_hyperlinks","mapFakeLinks","buildLinkData","newLinkId","shared","generateLinkId","saveLinkWithoutSelection","linkData","input","e","innerHTML","childNodes","nodeValue","hasLinkOnMultipleLineSelection","firstLineOfSelection","lastLineOfSelection","rep","attributeManager","foundLineWithLink","line","firstColumn","getFirstColumnOfSelection","lastColumn","getLastColumnOfSelection","hasLinkOnLine","selStart","lastColumnOfSelection","getLength","selEnd","lineNumber","foundLinkOnLine","column","undefined","object","getAttributesOnPosition","hasMultipleLineSelected","nextLine","startLineOffset","lines","offsetOfIndex","addTextOnClipboard","ace","padInner","removeSelection","linkIdOnFirstPositionSelected","hasLinkOnSelection","callWithAce","ace_getLinkIdOnFirstPositionSelected","ace_hasLinkOnSelection","contents","getSelection","getRangeAt","textSelected","textContent","htmlToCopy","JSON","stringify","originalEvent","clipboardData","setData","preventDefault","execCommand","getLinkIdOnFirstPositionSelected","this","documentAttributeManager","hasLink","saveLinks","getData","parse","pastedData","window","pastedDataHtml","pastedHtmlHolderElemenet","allLinksElement","getElementsByTagName","allLinksData","eachElemenet","tempHyperLink","href","tempHyperLinkText","className","id","author","timestamp","Date","getTime","hyperlink","headerId","date","formattedDate","append","clone","RegExp","expression","matches","allLinks","result","startsAt","indexOf","openTag","closeTag","join","endsAt","linkBoxes","padOuter","getPadOuter","getLinksContainer","hideAllLinks","hide","isLinkInternal","url","incomeURL","URL","origin","location","doesPInURL","pathname","split","padName","padMainPathname","substring","ep_singlePad","active","doesLinkHaveFilter","currentPathname","padNameIndex","filters","splice","showLink","show","hideLink","showLinkModal","linkObj","socket","linkModalAppended","linkModal","tmpl","targetLeft","clientX","offset","left","targetTop","target","top","parseInt","css","loaded","val","title","dividedUrl","console","log","error","ep_hyperlink_img","ep_hyperlink_title","card_loading_hyperlink","ep_hyperlink_description","changeMetaView","image","on","fadeOut","fadeIn","data-loaded","metaResolverCallBack","metadata","editedHyperlink","hostname","last","emit","shouldNotCloseLink","closest","internalLinkClick","event","stopPropagation","targetPath","search","tartge","history","pushState","type","open","newLink","submitNewLink","callback","form","oldText","buildLinkFrom","hideNewLinkPopup","blur","preLinkMarker","unmarkSelectedText","insertNewLinkPopupIfDontExist","remove","newLinkPopup","appendTo","showNewLinkPopup","markSelectedText","setTimeout","focus","select","preLinkMark","MARK_CLASS","self","highlightSelectedText","prototype","doNothing","performNonUnduableEvent","eventType","callstack","action","startNewEvent","handleMarkText","context","editorInfo","removeMarks","addMark","handleUnmarkText","editEvent","ace_setAttributeOnSelection","userId","originalSelStart","originalSelEnd","repArr","ace_getRepFromSelector","index","ace_performSelectionChange","init","hook","fakeLink","cc","doAttrib","state","getMapfakeLinks"],"mappings":"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","file":"ep.full.hyperlinks.mini.js","sourcesContent":["// https://github.com/ogt/valid-url\r\n\r\nconst validUrl = (function () {\r\n  'use strict';\r\n\r\n  // private function\r\n  // internal URI spitter method - direct from RFC 3986\r\n  const splitUri = function (uri) {\r\n    const splitted = uri.match(/(?:([^:\\/?#]+):)?(?:\\/\\/([^\\/?#]*))?([^?#]*)(?:\\?([^#]*))?(?:#(.*))?/);\r\n    return splitted;\r\n  };\r\n\r\n  function is_iri(value) {\r\n    if (!value) {\r\n      return;\r\n    }\r\n\r\n    // check for illegal characters\r\n    if (/[^a-z0-9\\:\\/\\?\\#\\[\\]\\@\\!\\$\\&\\'\\(\\)\\*\\+\\,\\;\\=\\.\\-\\_\\~\\%]/i.test(value)) return;\r\n\r\n    // check for hex escapes that aren't complete\r\n    if (/%[^0-9a-f]/i.test(value)) return;\r\n    if (/%[0-9a-f](:?[^0-9a-f]|$)/i.test(value)) return;\r\n\r\n    let splitted = [];\r\n    let scheme = '';\r\n    let authority = '';\r\n    let path = '';\r\n    let query = '';\r\n    let fragment = '';\r\n    let out = '';\r\n\r\n    // from RFC 3986\r\n    splitted = splitUri(value);\r\n    scheme = splitted[1];\r\n    authority = splitted[2];\r\n    path = splitted[3];\r\n    query = splitted[4];\r\n    fragment = splitted[5];\r\n\r\n    // scheme and path are required, though the path can be empty\r\n    if (!(scheme && scheme.length && path.length >= 0)) return;\r\n\r\n    // if authority is present, the path must be empty or begin with a /\r\n    if (authority && authority.length) {\r\n      if (!(path.length === 0 || /^\\//.test(path))) return;\r\n    } else {\r\n      // if authority is not present, the path must not start with //\r\n      if (/^\\/\\//.test(path)) return;\r\n    }\r\n\r\n    // scheme must begin with a letter, then consist of letters, digits, +, ., or -\r\n    if (!/^[a-z][a-z0-9\\+\\-\\.]*$/.test(scheme.toLowerCase())) return;\r\n\r\n    // re-assemble the URL per section 5.3 in RFC 3986\r\n    out += `${scheme}:`;\r\n    if (authority && authority.length) {\r\n      out += `//${authority}`;\r\n    }\r\n\r\n    out += path;\r\n\r\n    if (query && query.length) {\r\n      out += `?${query}`;\r\n    }\r\n\r\n    if (fragment && fragment.length) {\r\n      out += `#${fragment}`;\r\n    }\r\n\r\n    return out;\r\n  }\r\n\r\n  function is_http_iri(value, allowHttps) {\r\n    if (!is_iri(value)) {\r\n      return;\r\n    }\r\n\r\n    let splitted = [];\r\n    let scheme = '';\r\n    let authority = '';\r\n    let path = '';\r\n    let port = '';\r\n    let query = '';\r\n    let fragment = '';\r\n    let out = '';\r\n\r\n    // from RFC 3986\r\n    splitted = splitUri(value);\r\n    scheme = splitted[1];\r\n    authority = splitted[2];\r\n    path = splitted[3];\r\n    query = splitted[4];\r\n    fragment = splitted[5];\r\n\r\n    if (!scheme) return;\r\n\r\n    if (allowHttps) {\r\n      if (scheme.toLowerCase() != 'https') return;\r\n    } else if (scheme.toLowerCase() != 'http') { return; }\r\n\r\n    // fully-qualified URIs must have an authority section that is\r\n    // a valid host\r\n    if (!authority) {\r\n      return;\r\n    }\r\n\r\n    // enable port component\r\n    if (/:(\\d+)$/.test(authority)) {\r\n      port = authority.match(/:(\\d+)$/)[0];\r\n      authority = authority.replace(/:\\d+$/, '');\r\n    }\r\n\r\n    out += `${scheme}:`;\r\n    out += `//${authority}`;\r\n\r\n    if (port) {\r\n      out += port;\r\n    }\r\n\r\n    out += path;\r\n\r\n    if (query && query.length) {\r\n      out += `?${query}`;\r\n    }\r\n\r\n    if (fragment && fragment.length) {\r\n      out += `#${fragment}`;\r\n    }\r\n\r\n    return out;\r\n  }\r\n\r\n  function is_https_iri(value) {\r\n    return is_http_iri(value, true);\r\n  }\r\n\r\n  function is_web_iri(value) {\r\n    return (is_http_iri(value) || is_https_iri(value));\r\n  }\r\n\r\n  return {\r\n    is_uri: is_iri,\r\n    is_http_uri: is_http_iri,\r\n    is_https_uri: is_https_iri,\r\n    is_web_uri: is_web_iri,\r\n    isUri: is_iri,\r\n    isHttpUri: is_http_iri,\r\n    isHttpsUri: is_https_iri,\r\n    isWebUri: is_web_iri,\r\n  };\r\n})();\r\n","'use strict';\r\n\r\nconst events = (() => {\r\n  const addTextOnClipboard = (e, ace, padInner, removeSelection, links) => {\r\n    let linkIdOnFirstPositionSelected;\r\n    let hasLinkOnSelection;\r\n    ace.callWithAce((ace) => {\r\n      linkIdOnFirstPositionSelected =\r\n\t\t\t\tace.ace_getLinkIdOnFirstPositionSelected();\r\n      hasLinkOnSelection = ace.ace_hasLinkOnSelection();\r\n    });\r\n\r\n    if (hasLinkOnSelection) {\r\n      let linksData;\r\n      const range = padInner.contents()[0].getSelection().getRangeAt(0);\r\n      const rawHtml = createHiddenDiv(range);\r\n      let html = rawHtml;\r\n      const onlyTextIsSelected = selectionHasOnlyText(rawHtml);\r\n\r\n      // when the range selection is fully inside a tag, 'rawHtml' will have no HTML tag, so we have to\r\n      // build it. Ex: if we have '<span>ab<b>cdef</b>gh</span>\" and user selects 'de', the value of\r\n      // 'rawHtml' will be 'de', not '<b>de</b>'. As it is not possible to have two links in the same text\r\n      // linkIdOnFirstPositionSelected is the linkId in this partial selection\r\n      if (onlyTextIsSelected) {\r\n        const textSelected = rawHtml[0].textContent;\r\n        html = buildHtmlToCopyWhenSelectionHasOnlyText(\r\n            textSelected,\r\n            range,\r\n            linkIdOnFirstPositionSelected\r\n        );\r\n      }\r\n      const linkIds = getLinkIds(html);\r\n      linksData = buildLinksData(html, links);\r\n      const htmlToCopy = replaceLinkIdsWithFakeIds(linksData, html);\r\n      linksData = JSON.stringify(linksData);\r\n      e.originalEvent.clipboardData.setData('text/objectLink', linksData);\r\n      // here we override the default copy behavior\r\n      e.originalEvent.clipboardData.setData('text/html', htmlToCopy);\r\n      e.preventDefault();\r\n\r\n      // if it is a cut event we have to remove the selection\r\n      if (removeSelection) {\r\n        padInner.contents()[0].execCommand('delete');\r\n      }\r\n    }\r\n  };\r\n\r\n  const buildLinkIdToFakeIdMap = (linksData) => {\r\n    const linkIdToFakeId = {};\r\n    _.each(linksData, (link, fakeLinkId) => {\r\n      const linkId = link.data.originalLinkId;\r\n      linkIdToFakeId[linkId] = fakeLinkId;\r\n    });\r\n    return linkIdToFakeId;\r\n  };\r\n\r\n  const replaceLinkIdsWithFakeIds = (linksData, html) => {\r\n    const linkIdToFakeId = buildLinkIdToFakeIdMap(linksData);\r\n    _.each(linkIdToFakeId, (fakeLinkId, linkId) => {\r\n      $(html).find(`.${linkId}`).removeClass(linkId).addClass(fakeLinkId);\r\n    });\r\n    const htmlWithFakeLinkIds = getHtml(html);\r\n    return htmlWithFakeLinkIds;\r\n  };\r\n\r\n  const buildLinksData = (html, links) => {\r\n    const linksData = {};\r\n    const originalLinkIds = getLinkIds(html);\r\n    _.each(originalLinkIds, (originalLinkId) => {\r\n      const fakeLinkId = generateFakeLinkId();\r\n      const link = links[originalLinkId];\r\n      link.data.originalLinkId = originalLinkId;\r\n      linksData[fakeLinkId] = link;\r\n    });\r\n    return linksData;\r\n  };\r\n\r\n  const generateFakeLinkId = () => `fakelink-${randomString(16)}`;\r\n\r\n  const getLinkIds = (html) => {\r\n    const allSpans = $(html).find('span');\r\n    const linkIds = [];\r\n    _.each(allSpans, (span) => {\r\n      const cls = $(span).attr('class');\r\n      const classLinkId = /(?:^| )(lc-[A-Za-z0-9]*)/.exec(cls);\r\n      const linkId = classLinkId ? classLinkId[1] : false;\r\n      if (linkId) {\r\n        linkIds.push(linkId);\r\n      }\r\n    });\r\n    const uniqueLinkIds = _.uniq(linkIds);\r\n    return uniqueLinkIds;\r\n  };\r\n\r\n  const createHiddenDiv = (range) => {\r\n    const content = range.cloneContents();\r\n    const div = document.createElement('div');\r\n    const hiddenDiv = $(div).html(content);\r\n    return hiddenDiv;\r\n  };\r\n\r\n  const getHtml = (hiddenDiv) => $(hiddenDiv).html();\r\n\r\n  const selectionHasOnlyText = (rawHtml) => {\r\n    const html = getHtml(rawHtml);\r\n    const htmlDecoded = htmlDecode(html);\r\n    const text = $(rawHtml).text();\r\n    return htmlDecoded === text;\r\n  };\r\n\r\n  const buildHtmlToCopyWhenSelectionHasOnlyText = (text, range, linkId) => {\r\n    const htmlWithSpans = buildHtmlWithTwoSpanTags(text, linkId);\r\n    const html = buildHtmlWithFormattingTagsOfSelection(htmlWithSpans, range);\r\n\r\n    const htmlToCopy = $.parseHTML(`<div>${html}</div>`);\r\n    return htmlToCopy;\r\n  };\r\n\r\n  const buildHtmlWithFormattingTagsOfSelection = (html, range) => {\r\n    const htmlOfParentNode = range.commonAncestorContainer.parentNode;\r\n    const tags = getTagsInSelection(htmlOfParentNode);\r\n\r\n    // this case happens when we got a selection with one or more styling (bold, italic, underline, strikethrough)\r\n    // applied in all selection in the same range. For example, <b><i><u>text</u></i></b>\r\n    if (tags) {\r\n      html = buildOpenTags(tags) + html + buildCloseTags(tags);\r\n    }\r\n\r\n    return html;\r\n  };\r\n\r\n  // FIXME - Allow to copy a link when user copies only one char\r\n  // This is a hack to preserve the link classes when user pastes a link. When user pastes a span like this\r\n  // <span class='link c-124'>thing</span>, chrome removes the classes and keeps only the style of the class. With links\r\n  // chrome keeps the background-color. To avoid this we create two spans. The first one, <span class='link c-124'>thi</span>\r\n  // has the text until the last but one character and second one with the last character <span class='link c-124'>g</span>.\r\n  // Etherpad does a good job joining the two spans into one after the paste is triggered.\r\n  const buildHtmlWithTwoSpanTags = (text, linkId) => {\r\n    const firstSpan = `<span class=\"link ${linkId}\">${text.slice(\r\n        0,\r\n        -1\r\n    )}</span>`; // text until before last char\r\n    const secondSpan = `<span class=\"link ${linkId}\">${text.slice(-1)}</span>`; // last char\r\n\r\n    return firstSpan + secondSpan;\r\n  };\r\n\r\n  const buildOpenTags = (tags) => {\r\n    let openTags = '';\r\n    tags.forEach((tag) => {\r\n      openTags += `<${tag}>`;\r\n    });\r\n    return openTags;\r\n  };\r\n\r\n  const buildCloseTags = (tags) => {\r\n    let closeTags = '';\r\n    var tags = tags.reverse();\r\n    tags.forEach((tag) => {\r\n      closeTags += `</${tag}>`;\r\n    });\r\n    return closeTags;\r\n  };\r\n\r\n  const getTagsInSelection = (htmlObject) => {\r\n    const tags = [];\r\n    let tag;\r\n    if ($(htmlObject)[0].hasOwnProperty('localName')) {\r\n      while ($(htmlObject)[0].localName !== 'span') {\r\n        const html = $(htmlObject).prop('outerHTML');\r\n        const stylingTagRegex = /<(b|i|u|s)>/.exec(html);\r\n        tag = stylingTagRegex ? stylingTagRegex[1] : '';\r\n        tags.push(tag);\r\n        htmlObject = $(htmlObject).parent();\r\n      }\r\n    }\r\n    return tags;\r\n  };\r\n\r\n  const saveLinks = (e, padInner) => {\r\n    let links = e.originalEvent.clipboardData.getData('text/objectLink');\r\n\r\n    if (links) {\r\n      links = JSON.parse(links);\r\n      saveLink(links);\r\n    } else {\r\n      let clipboardData, pastedData;\r\n      let text = '';\r\n\r\n      clipboardData = e.originalEvent.clipboardData || window.clipboardData;\r\n      pastedData = clipboardData.getData('text');\r\n      const pastedDataHtml = clipboardData.getData('text/html');\r\n      const range = padInner.contents()[0].getSelection().getRangeAt(0);\r\n\r\n      if (!range) return false;\r\n\r\n      if (!pastedDataHtml) {\r\n        if (\r\n          new RegExp(\r\n              '([a-zA-Z0-9]+://)?([a-zA-Z0-9_]+:[a-zA-Z0-9_]+@)?([a-zA-Z0-9.-]+\\\\.[A-Za-z]{2,4})(:[0-9]+)?(/.*)?'\r\n          ).test(pastedData)\r\n        ) {\r\n          const expression =\r\n\t\t\t\t\t\t/(https?:\\/\\/(?:www\\.|(?!www))[^\\s\\.]+\\.[^\\s]{2,}|www\\.[^\\s]+\\.[^\\s]{2,})/gi;\r\n          const matches = pastedData.match(expression);\r\n          const allLinks = {};\r\n          if (matches) {\r\n            for (match in matches.reverse()) {\r\n              // because of characters position need to be fixed and going to add tags from end\r\n              const result = {};\r\n              const newLinkId = shared.generateLinkId();\r\n              result.link = matches[match];\r\n\r\n              // allLinks.push(fakeLinkId)\r\n              allLinks[newLinkId] = {\r\n                data: {\r\n                  author: 'empty',\r\n                  linkId: newLinkId,\r\n                  timestamp: new Date().getTime(),\r\n                  text: result.link,\r\n                  originalLinkId: newLinkId,\r\n                  hyperlink: result.link,\r\n                  headerId: null,\r\n                  date: new Date(),\r\n                  formattedDate: new Date(),\r\n                },\r\n              };\r\n              result.startsAt = pastedData.indexOf(matches[match]);\r\n              const openTag = `<span id=\"${newLinkId}\" class=\"${newLinkId}\">`;\r\n              const closeTag = '</span>';\r\n              pastedData = [\r\n                pastedData.slice(0, result.startsAt),\r\n                openTag,\r\n                pastedData.slice(result.startsAt),\r\n              ].join('');\r\n              result.endsAt =\r\n\t\t\t\t\t\t\t\tpastedData.indexOf(matches[match]) + matches[match].length;\r\n              pastedData = [\r\n                pastedData.slice(0, result.endsAt),\r\n                closeTag,\r\n                pastedData.slice(result.endsAt),\r\n              ].join('');\r\n            }\r\n            pastedData = pastedData.replace(/(?:\\r\\n|\\r|\\n)/g, '<br>');\r\n            text = $('<div></div>').html(pastedData);\r\n            padInner\r\n                .contents()[0]\r\n                .execCommand(\r\n                    'insertHTML',\r\n                    false,\r\n                    $('<div>').append($(text).clone()).html()\r\n                );\r\n            pad.plugins.ep_full_hyperlinks.saveLinkWithoutSelection(\r\n                clientVars.padId,\r\n                allLinks\r\n            );\r\n            e.preventDefault();\r\n          }\r\n        }\r\n      } else {\r\n        // it means pasted in html\r\n        e.preventDefault();\r\n        const pastedHtmlHolderElemenet = document.createElement('div');\r\n        pastedHtmlHolderElemenet.innerHTML = pastedDataHtml;\r\n        const allLinksElement =\r\n\t\t\t\t\tpastedHtmlHolderElemenet.getElementsByTagName('a');\r\n        const allLinksData = {};\r\n        _.each(allLinksElement, (eachElemenet) => {\r\n          const tempHyperLink = eachElemenet.href;\r\n          const tempHyperLinkText = eachElemenet.innerHTML;\r\n          const newLinkId = shared.generateLinkId();\r\n          eachElemenet.className = newLinkId;\r\n          eachElemenet.id = newLinkId;\r\n          allLinksData[newLinkId] = {\r\n            data: {\r\n              author: 'empty',\r\n              linkId: newLinkId,\r\n              timestamp: new Date().getTime(),\r\n              text: tempHyperLinkText,\r\n              originalLinkId: newLinkId,\r\n              hyperlink: tempHyperLink,\r\n              headerId: null,\r\n              date: new Date(),\r\n              formattedDate: new Date(),\r\n            },\r\n          };\r\n        });\r\n        pad.plugins.ep_full_hyperlinks.saveLinkWithoutSelection(\r\n            clientVars.padId,\r\n            allLinksData\r\n        );\r\n        padInner\r\n            .contents()[0]\r\n            .execCommand(\r\n                'insertHTML',\r\n                false,\r\n                $('<div>').append($(pastedHtmlHolderElemenet).clone()).html()\r\n            );\r\n      }\r\n    }\r\n  };\r\n\r\n  const saveLink = (links) => {\r\n    const linksToSave = {};\r\n    const padId = clientVars.padId;\r\n\r\n    const mapOriginalLinksId =\r\n\t\t\tpad.plugins.ep_full_hyperlinks.mapOriginalLinksId;\r\n    const mapFakeLinks = pad.plugins.ep_full_hyperlinks.mapFakeLinks;\r\n\r\n    _.each(links, (link, fakeLinkId) => {\r\n      const linkData = buildLinkData(link, fakeLinkId);\r\n      const newLinkId = shared.generateLinkId();\r\n      mapFakeLinks[fakeLinkId] = newLinkId;\r\n      const originalLinkId = link.data.originalLinkId;\r\n      mapOriginalLinksId[originalLinkId] = newLinkId;\r\n      linksToSave[newLinkId] = link;\r\n    });\r\n\r\n    pad.plugins.ep_full_hyperlinks.saveLinkWithoutSelection(padId, linksToSave);\r\n  };\r\n\r\n  const buildLinkData = (link, fakeLinkId) => {\r\n    const linkData = {};\r\n    linkData.padId = clientVars.padId;\r\n    linkData.link = link.data;\r\n    linkData.link.linkId = fakeLinkId;\r\n    return linkData;\r\n  };\r\n\r\n  // copied from https://css-tricks.com/snippets/javascript/unescape-html-in-js/\r\n  const htmlDecode = (input) => {\r\n    const e = document.createElement('div');\r\n    e.innerHTML = input;\r\n    return e.childNodes.length === 0 ? '' : e.childNodes[0].nodeValue;\r\n  };\r\n\r\n  // here we find the link id on a position [line, column]. This function is used to get the link id\r\n  // of one line when there is ONLY text selected. E.g In the line with link, <span class='link...'>something</span>,\r\n  // and user copies the text 'omethin'. The span tags are not copied only the text. So as the link is\r\n  // applied on the selection we get the linkId using the first position selected of the line.\r\n  // P.S: It's not possible to have two or more links when there is only text selected, because for each link\r\n  // created it's generated a <span> and to copy only the text it MUST NOT HAVE any tag on the selection\r\n  const getLinkIdOnFirstPositionSelected = function () {\r\n    const attributeManager = this.documentAttributeManager;\r\n    const rep = this.rep;\r\n    const linkId = _.object(\r\n        attributeManager.getAttributesOnPosition(rep.selStart[0], rep.selStart[1])\r\n    ).link;\r\n    return linkId;\r\n  };\r\n\r\n  const hasLinkOnSelection = function () {\r\n    let hasLink;\r\n    const attributeManager = this.documentAttributeManager;\r\n    const rep = this.rep;\r\n    const firstLineOfSelection = rep.selStart[0];\r\n    const firstColumn = rep.selStart[1];\r\n    const lastColumn = rep.selEnd[1];\r\n    const lastLineOfSelection = rep.selEnd[0];\r\n    const selectionOfMultipleLine = hasMultipleLineSelected(\r\n        firstLineOfSelection,\r\n        lastLineOfSelection\r\n    );\r\n\r\n    if (selectionOfMultipleLine) {\r\n      hasLink = hasLinkOnMultipleLineSelection(\r\n          firstLineOfSelection,\r\n          lastLineOfSelection,\r\n          rep,\r\n          attributeManager\r\n      );\r\n    } else {\r\n      hasLink = hasLinkOnLine(\r\n          firstLineOfSelection,\r\n          firstColumn,\r\n          lastColumn,\r\n          attributeManager\r\n      );\r\n    }\r\n    return hasLink;\r\n  };\r\n\r\n  const hasLinkOnMultipleLineSelection = (\r\n      firstLineOfSelection,\r\n      lastLineOfSelection,\r\n      rep,\r\n      attributeManager\r\n  ) => {\r\n    let foundLineWithLink = false;\r\n    for (\r\n      let line = firstLineOfSelection;\r\n      line <= lastLineOfSelection && !foundLineWithLink;\r\n      line++\r\n    ) {\r\n      const firstColumn = getFirstColumnOfSelection(\r\n          line,\r\n          rep,\r\n          firstLineOfSelection\r\n      );\r\n      const lastColumn = getLastColumnOfSelection(\r\n          line,\r\n          rep,\r\n          lastLineOfSelection\r\n      );\r\n      const hasLink = hasLinkOnLine(\r\n          line,\r\n          firstColumn,\r\n          lastColumn,\r\n          attributeManager\r\n      );\r\n      if (hasLink) {\r\n        foundLineWithLink = true;\r\n      }\r\n    }\r\n    return foundLineWithLink;\r\n  };\r\n\r\n  const getFirstColumnOfSelection = (line, rep, firstLineOfSelection) => line !== firstLineOfSelection ? 0 : rep.selStart[1];\r\n\r\n  const getLastColumnOfSelection = (line, rep, lastLineOfSelection) => {\r\n    let lastColumnOfSelection;\r\n    if (line !== lastLineOfSelection) {\r\n      lastColumnOfSelection = getLength(line, rep); // length of line\r\n    } else {\r\n      lastColumnOfSelection = rep.selEnd[1] - 1; // position of last character selected\r\n    }\r\n    return lastColumnOfSelection;\r\n  };\r\n\r\n  const hasLinkOnLine = (\r\n      lineNumber,\r\n      firstColumn,\r\n      lastColumn,\r\n      attributeManager\r\n  ) => {\r\n    let foundLinkOnLine = false;\r\n    for (\r\n      let column = firstColumn;\r\n      column <= lastColumn && !foundLinkOnLine;\r\n      column++\r\n    ) {\r\n      const linkId = _.object(\r\n          attributeManager.getAttributesOnPosition(lineNumber, column)\r\n      ).link;\r\n      if (linkId !== undefined) {\r\n        foundLinkOnLine = true;\r\n      }\r\n    }\r\n    return foundLinkOnLine;\r\n  };\r\n\r\n  const hasMultipleLineSelected = (firstLineOfSelection, lastLineOfSelection) => firstLineOfSelection !== lastLineOfSelection;\r\n\r\n  const getLength = (line, rep) => {\r\n    const nextLine = line + 1;\r\n    const startLineOffset = rep.lines.offsetOfIndex(line);\r\n    const endLineOffset = rep.lines.offsetOfIndex(nextLine);\r\n\r\n    // lineLength without \\n\r\n    const lineLength = endLineOffset - startLineOffset - 1;\r\n\r\n    return lineLength;\r\n  };\r\n\r\n  return {\r\n    addTextOnClipboard,\r\n    getLinkIdOnFirstPositionSelected,\r\n    hasLinkOnSelection,\r\n    saveLinks,\r\n  };\r\n})();\r\n","'use strict'\r\n\r\n\r\nconst linkBoxes = (() => {\r\n\tlet padOuter;\r\n\tconst getPadOuter = () =>\r\n\t\t(padOuter = padOuter || $('iframe[name=\"ace_outer\"]').contents());\r\n\r\n\tconst getLinksContainer = () => getPadOuter().find(\"#linkBoxWrapper\");\r\n\r\n\t/* ***** Public methods: ***** */\r\n\r\n\tconst showLink = (linkId) => getLinksContainer().find(`#${linkId}`).show();\r\n\r\n\tconst hideLink = (linkId) => {\r\n\t\tgetLinksContainer().find(`#${linkId}`).hide();\r\n\t\tpadOuter.find(`#show-form-${linkId}`).show();\r\n\t\tpadOuter.find(`#edit-form-${linkId}`).hide();\r\n\t};\r\n\r\n\tconst hideAllLinks = () => getLinksContainer().find(`.link-container`).hide();\r\n\r\n\tconst showLinkModal = (e, linkObj, socket) => {\r\n\t\tconst padOuter = $('iframe[name=\"ace_outer\"]').contents();\r\n\t\tconst padInner = getPadOuter().find('iframe[name=\"ace_inner\"]');\r\n\t\tconst linkId = linkObj.linkId;\r\n\t\tconst linkModalAppended =\r\n\t\t\tgetLinksContainer().find(`#${linkId}`).length === 0 ? false : true;\r\n\r\n\t\thideAllLinks();\r\n\r\n\t\t// find link modal, if does not exist create a link modal\r\n\t\tlet linkModal = getLinksContainer().find(`#${linkId}`);\r\n\t\tif (!linkModalAppended)\r\n\t\t\tlinkModal = $(\"#linkBoxTemplate\").tmpl({ ...linkObj });\r\n\r\n\t\t// apppend modal position! where it want appear\r\n\t\tlet targetLeft = e.clientX;\r\n\t\ttargetLeft += padInner.offset().left;\r\n\t\tlet targetTop = $(e.target).offset().top;\r\n\t\ttargetTop += parseInt(padInner.css(\"padding-top\").split(\"px\")[0]);\r\n\t\ttargetTop += parseInt(\r\n\t\t\tpadOuter.find(\"#outerdocbody\").css(\"padding-top\").split(\"px\")[0]\r\n\t\t);\r\n\r\n\t\tlinkModal.css({ left: `${parseInt(targetLeft)}px` });\r\n\t\tlinkModal.css({ top: `${parseInt(targetTop) + 35}px` });\r\n\t\tlinkModal.addClass(\"hyperlink-display\");\r\n\r\n\t\tconst loaded = linkModal.attr(\"data-loaded\");\r\n\r\n\t\t// if the linkModal was not appended, create a modal and append it to #linkBoxWrapper\r\n\t\tif (!linkModalAppended) {\r\n\t\t\tpadOuter.find(\"#linkBoxWrapper\").append(linkModal);\r\n\t\t} else {\r\n\t\t\t// if the modal was exist update text and hypertext\r\n\t\t\tlinkModal.show();\r\n\t\t\t// if the old hyperlink was not same as new hyperlink\r\n\t\t\tif (linkObj.hyperlink !== linkModal.find(\"a.ep_hyperlink_title\").attr(\"href\")) {\r\n\t\t\t\tlinkModal.attr(\"data-loaded\", \"false\");\r\n\t\t\t}\r\n\r\n\t\t\tlinkModal.attr(\"data-hyperlink\", linkObj.hyperlink);\r\n\t\t\tlinkModal.find(\"input#hyperlink-url\").val(linkObj.hyperlink);\r\n\r\n\t\t\tlinkModal.find(\"a.ep_hyperlink_title\").attr({\r\n\t\t\t\ttitle: linkObj.hyperlink,\r\n\t\t\t\thref: linkObj.hyperlink,\r\n\t\t\t});\r\n\t\t}\r\n\r\n\t\t// If the text we saved has changed and is different from the contents of the pad\r\n\t\tconst text = padInner.contents().find(`.${linkId}`).text()\r\n\t\tlinkModal.find(\"input#hyperlink-text-hidden\").val(text);\r\n\t\tlinkModal.find(\"input#hyperlink-text\").val(text);\r\n\r\n\t\t// TODO: 1/ hyperlink for social and\r\n\t\t// TODO: 2/ inside link\r\n\t\tif (loaded != \"true\") {\r\n\t\t\tlet hyperlink = linkObj.hyperlink || linkModal.attr(\"data-hyperlink\");\r\n\t\t\tconsole.log(hyperlink)\r\n\t\t\tlet dividedUrl;\r\n\t\t\ttry {\r\n\t\t\t\tdividedUrl = new URL(hyperlink);\r\n\t\t\t} catch (error) {\r\n\t\t\t\tconsole.error(`[hyperlink]: ${error}`);\r\n\t\t\t\tlinkBoxes.hideLink(linkId);\r\n\t\t\t\treturn\r\n\t\t\t}\r\n\r\n\t\t\tconst ep_hyperlink_img = linkModal.find(\"#ep_hyperlink_img\");\r\n\t\t\tconst ep_hyperlink_title = linkModal.find(\"a.ep_hyperlink_title\");\r\n\t\t\tconst card_loading_hyperlink = linkModal.find(\"#card_loading_hyperlink\");\r\n\t\t\tconst ep_hyperlink_description = linkModal.find(\r\n\t\t\t\t\"#ep_hyperlink_description\"\r\n\t\t\t);\r\n\r\n\t\t\tep_hyperlink_description.text(\"\");\r\n\t\t\tep_hyperlink_title.text(hyperlink);\r\n\r\n\t\t\tep_hyperlink_img.hide();\r\n\t\t\tep_hyperlink_title.show();\r\n\t\t\tcard_loading_hyperlink.show();\r\n\r\n\t\t\t// raise for og:title resolving\r\n\r\n\t\t\tif (!/^http:\\/\\//.test(hyperlink) && !/^https:\\/\\//.test(hyperlink)) {\r\n\t\t\t\thyperlink = `https://${hyperlink}`;\r\n\t\t\t}\r\n\r\n\t\t\tconst changeMetaView = function (hyperlink, title, image) {\r\n\t\t\t\tep_hyperlink_img.attr(\"src\", image);\r\n\t\t\t\tep_hyperlink_img.on(\"load\", () => {\r\n\t\t\t\t\tcard_loading_hyperlink.fadeOut(500, () => {\r\n\t\t\t\t\t\tep_hyperlink_img.fadeIn();\r\n\t\t\t\t\t\tep_hyperlink_title.text(\r\n\t\t\t\t\t\t\ttitle.replace(/^(?:https?:\\/\\/)?(?:www\\.)?/i, \"\")\r\n\t\t\t\t\t\t);\r\n\t\t\t\t\t\tep_hyperlink_description.text(\r\n\t\t\t\t\t\t\thyperlink.replace(/^(?:https?:\\/\\/)?(?:www\\.)?/i, \"\")\r\n\t\t\t\t\t\t);\r\n\t\t\t\t\t\tlinkModal.attr({ \"data-loaded\": true });\r\n\t\t\t\t\t});\r\n\t\t\t\t});\r\n\t\t\t};\r\n\t\t\t\r\n\t\t\tif (!validUrl.isUri(hyperlink)) {\r\n\t\t\t\tconst img =\r\n\t\t\t\t\t\"../static/plugins/ep_full_hyperlinks/static/dist/img/nometa.png\";\r\n\t\t\t\tchangeMetaView(hyperlink, hyperlink, img);\r\n\t\t\t\treturn false;\r\n\t\t\t}\r\n\t\t\t// ........\r\n\t\t\tconst metaResolverCallBack = function (result) {\r\n\r\n\t\t\t\tif (result.metadata.image && result.metadata.title) {\r\n\t\t\t\t\tchangeMetaView(\r\n\t\t\t\t\t\thyperlink,\r\n\t\t\t\t\t\tresult.metadata.title,\r\n\t\t\t\t\t\tresult.metadata.image\r\n\t\t\t\t\t);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tvar editedHyperlink = `https://${dividedUrl.hostname}`;\r\n\t\t\t\t\tif (result.last !== true) {\r\n\t\t\t\t\t\tsocket.emit(\r\n\t\t\t\t\t\t\t\"metaResolver\",\r\n\t\t\t\t\t\t\t{ padId: clientVars.padId, editedHyperlink, last: true },\r\n\t\t\t\t\t\t\tmetaResolverCallBack\r\n\t\t\t\t\t\t);\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tchangeMetaView(\r\n\t\t\t\t\t\t\thyperlink,\r\n\t\t\t\t\t\t\tresult.metadata.title || hyperlink,\r\n\t\t\t\t\t\t\t\"../static/plugins/ep_full_hyperlinks/static/dist/img/nometa.png\"\r\n\t\t\t\t\t\t);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t};\r\n\t\t\t// ........\r\n\t\t\tswitch (dividedUrl.hostname) {\r\n\t\t\t\tcase \"twitter.com\":\r\n\t\t\t\t\tchangeMetaView(\r\n\t\t\t\t\t\thyperlink,\r\n\t\t\t\t\t\thyperlink,\r\n\t\t\t\t\t\t\"../static/plugins/ep_full_hyperlinks/static/dist/img/twitter.png\"\r\n\t\t\t\t\t);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tdefault:\r\n\t\t\t\t\tsocket.emit(\r\n\t\t\t\t\t\t\"metaResolver\",\r\n\t\t\t\t\t\t{ padId: clientVars.padId, hyperlink, last: false },\r\n\t\t\t\t\t\tmetaResolverCallBack\r\n\t\t\t\t\t);\r\n\t\t\t}\r\n\t\t}\r\n\t};\r\n\r\n\t// Indicates if event was on one of the elements that does not close link\r\n\tconst shouldNotCloseLink = function (e) {\r\n\t\t// a link box\r\n\t\tif (\r\n\t\t\t$(e.target).closest(\".link\").length ||\r\n\t\t\t$(e.target).closest(\".link-modal\").length ||\r\n\t\t\t$(e.target).closest(\".ep_hyperlink_docs_bubble_button_edit\").length ||\r\n\t\t\t$(e.target).closest(\".ep_hyperlink_docs_bubble_button_delete\").length ||\r\n\t\t\t$(e.target).closest(\".ep_hyperlink_docs_bubble_button_copy\").length ||\r\n\t\t\t$(e.target).closest(\".full-display-link\").length ||\r\n\t\t\t$(e.target).closest(\".link-title-wrapper\").length ||\r\n\t\t\t$(e.target).closest(\".link-edit-form\").length ||\r\n\t\t\t$(e.target).closest(\".link-text-text\").length ||\r\n\t\t\t$(e.target).closest(\".link-text-hyperlink\").length\r\n\t\t) {\r\n\t\t\t// the link modal\r\n\t\t\treturn true;\r\n\t\t}\r\n\t\treturn false;\r\n\t};\r\n\r\n\tconst isLinkInternal = (url) => {\r\n\t\tconst incomeURL = new URL(url);\r\n\t\tlet result = false;\r\n\r\n\t\t// 1/ check the origin\r\n\t\tif(incomeURL.origin !== location.origin) return false;\r\n\r\n\r\n\t\t// 2/ origin the same but diff pad name\r\n\t\t// check if the income url related to filter url\r\n\t\tif(incomeURL.origin === location.origin){\r\n\t\t\t// does have p\r\n\t\t\tconst doesPInURL = location.pathname.split('/').indexOf('p') > 0;\r\n\t\t\tconst padName = clientVars.padId;\r\n\t\t\tconst padMainPathname = doesPInURL ? `/p/${padName}` : `/${padName}`;\r\n\t\t\t// check if the income url pad name is the same current pad name\r\n\t\t\tif(location.pathname.substring(0, padMainPathname.length) === padMainPathname) result = true\r\n\r\n\t\t\t// does single pad active\r\n\t\t\tif(clientVars.ep_singlePad.active) result = true;\r\n\r\n\t\t}\r\n\r\n\t\treturn result;\r\n\t}\r\n\r\n\tconst doesLinkHaveFilter = (url) => {\r\n\t\tconst result = [];\r\n\t\tconst padName = clientVars.padId;\r\n\r\n\t\tconst currentPathname = url.pathname.split(\"/\");\r\n\r\n\t\tlet padNameIndex = currentPathname.indexOf(padName) + 1;\r\n\r\n\t\tif(clientVars.ep_singlePad.active) padNameIndex = 0;\r\n\r\n\t\tconst filters = [...currentPathname].splice(padNameIndex, currentPathname.length - 1);\r\n\r\n\t\tresult.push(...filters);\r\n\r\n\t\treturn result;\r\n\t}\r\n\r\n\t// internal link\r\n\t// other plugin must listen for pushstate to get new data and excute they part.\r\n\tconst internalLinkClick = function (event) {\r\n\t\tevent.preventDefault();\r\n\t\tevent.stopPropagation();\r\n\t\tconst href = $(this).attr('href');\r\n\r\n\r\n\t\tconsole.log(\"internalLinkClick\", href, isLinkInternal(href), doesLinkHaveFilter(new URL(href)))\r\n\r\n\t\tif(isLinkInternal(href)){\r\n\t\t\tconst incomeURL = new URL(href);\r\n\t\t\tlet targetPath = `${incomeURL.search}`\r\n\t\t\tconst filters = doesLinkHaveFilter(incomeURL);\r\n\r\n\t\t\tif(filters.length>0){\r\n\t\t\t\tconst doesPInURL = location.pathname.split('/').indexOf('p') > 0;\r\n\t\t\t\ttargetPath = doesPInURL ? '/p': '';\r\n\t\t\t\tif(!clientVars.ep_singlePad.active) targetPath += `/${clientVars.padId}`;\r\n\t\t\t\ttargetPath += `/${filters.join('/')}${incomeURL.search}`;\r\n\t\t\t}\r\n\r\n\t\t\tif(incomeURL.search.length===0) targetPath = href;\r\n\r\n\t\t\t// The Target is which plugin should listen more for more functionality\r\n\t\t\t// In this example, if we find a slug filter in your URL,\r\n\t\t\t// the target should be the filter plugin\r\n\t\t\tconst tartge = filters.length>0 ? \"filter\" : \"other\";\r\n\t\t\r\n\t\t\twindow.history.pushState({type: \"hyperLink\", href, target: tartge}, document.title, targetPath);\r\n\t\t\t// close all link\r\n\t\t\thideAllLinks();\r\n\t\t}else {\r\n\t\t\twindow.open(href, '_blank');\r\n\t\t}\r\n\t\treturn false;\r\n\t}\r\n\r\n\treturn {\r\n\t\tshowLink,\r\n\t\thideLink,\r\n\t\thideAllLinks,\r\n\t\tshowLinkModal,\r\n\t\tgetLinksContainer,\r\n\t\tshouldNotCloseLink,\r\n\t\tinternalLinkClick,\r\n\t};\r\n})();\r\n","'use strict';\r\n\r\nconst newLink = (() => {\r\n  // Create a link object with data filled on the given form\r\n  const buildLinkFrom = (form) => {\r\n    const text = form.find('#hyperlink-text').val();\r\n    const oldText = form.find('#hyperlink-text-hidden').val();\r\n    const hyperlink = form.find('#hyperlink-url').val();\r\n\r\n    return {\r\n      text,\r\n      oldText,\r\n      hyperlink,\r\n    };\r\n  };\r\n\r\n  // Callback for new link Cancel\r\n  const cancelNewLink = () => hideNewLinkPopup();\r\n\r\n  // Callback for new link Submit\r\n  const submitNewLink = function (callback) {\r\n    const index = 0;\r\n    const form = $(document).find('#newLink');\r\n    const link = buildLinkFrom(form);\r\n    if (link.text.length > 0 && validUrl.isUri(link.hyperlink)) {\r\n      form.find('#hyperlink-text, #hyperlink-url').removeClass('error');\r\n      hideNewLinkPopup();\r\n      callback(link, index);\r\n    } else {\r\n      if (link.text.length === 0) form.find('#hyperlink-text').addClass('error');\r\n      if (!validUrl.isUri(link.hyperlink)) form.find('#hyperlink-url').addClass('error');\r\n    }\r\n    return false;\r\n  };\r\n\r\n  /* ***** Public methods: ***** */\r\n\r\n  // Insert new Link Form\r\n  const insertNewLinkPopupIfDontExist = (link, callback) => {\r\n    $('#newLink').remove();\r\n    link.linkId = '';\r\n    const newLinkPopup = $('#newLinkTemplate').tmpl(link);\r\n    newLinkPopup.appendTo($('#editorcontainerbox'));\r\n\r\n    // Cancel btn\r\n    $('#newLink #link-cancel-btn').on('click', (e) => cancelNewLink());\r\n\r\n    // Create btn // link-create-btn\r\n    $('#newLink #link-create-btn').on('click', (e) => submitNewLink(callback));\r\n\r\n\t\t$(document).on('submit', 'form.link-edit-form', function(e){\r\n\t\t\te.preventDefault();\r\n\t\t\tsubmitNewLink(callback)\r\n\t\t})\r\n\r\n    return newLinkPopup;\r\n  };\r\n\r\n  const showNewLinkPopup = () => {\r\n    // position below link icon\r\n    $('#newLink').css('left', $('.toolbar .addLink').offset().left);\r\n\r\n    // Reset form to make sure it is all clear\r\n    $('#newLink').find('textarea').val('');\r\n    $('#newLink').find('.link-content, .to-value').removeClass('error');\r\n\r\n    // Show popup\r\n    $('#newLink').addClass('popup-show');\r\n\r\n    // mark selected text, so it is clear to user which text range the link is being applied to\r\n    pad.plugins.ep_full_hyperlinks.preLinkMarker.markSelectedText();\r\n\r\n    // focus on hyperlink input\r\n\r\n    setTimeout(() => {\r\n      $('#newLink').find('.link-content').focus().select();\r\n    }, 500);\r\n  };\r\n\r\n  const hideNewLinkPopup = () => {\r\n    $('#newLink').removeClass('popup-show');\r\n\r\n    // force focus to be lost, so virtual keyboard is hidden on mobile devices\r\n    $('#newLink').find(':focus').blur();\r\n\r\n    // unmark selected text, as now there is no text being linked\r\n    pad.plugins.ep_full_hyperlinks.preLinkMarker.unmarkSelectedText();\r\n  };\r\n\r\n  return {\r\n    // localizenewLinkPopup,\r\n    insertNewLinkPopupIfDontExist,\r\n    showNewLinkPopup,\r\n    hideNewLinkPopup,\r\n  };\r\n})();\r\n","'use strict';\r\n\r\nconst preLinkMark = (() => {\r\n  const MARK_CLASS = 'pre-selected-link';\r\n\r\n  const preLinkMarker = function (ace) {\r\n    this.ace = ace;\r\n    const self = this;\r\n\r\n    // do nothing if this feature is not enabled\r\n    if (!this.highlightSelectedText()) return;\r\n\r\n    // remove any existing marks, as there is no link being added on plugin initialization\r\n    // (we need the timeout to let the plugin be fully initialized before starting to remove\r\n    // marked texts)\r\n    setTimeout(() => {\r\n      self.unmarkSelectedText();\r\n    }, 0);\r\n  };\r\n\r\n  // Indicates if Etherpad is configured to highlight text\r\n  preLinkMarker.prototype.highlightSelectedText = function () {\r\n    return clientVars.highlightSelectedText;\r\n  };\r\n\r\n  preLinkMarker.prototype.markSelectedText = function () {\r\n    // do nothing if this feature is not enabled\r\n    if (!this.highlightSelectedText()) return;\r\n\r\n    this.ace.callWithAce(doNothing, 'markPreSelectedTextToLink', true);\r\n  };\r\n\r\n  preLinkMarker.prototype.unmarkSelectedText = function () {\r\n    // do nothing if this feature is not enabled\r\n    if (!this.highlightSelectedText()) return;\r\n\r\n    this.ace.callWithAce(doNothing, 'unmarkPreSelectedTextToLink', true);\r\n  };\r\n\r\n  preLinkMarker.prototype.performNonUnduableEvent = function (eventType, callstack, action) {\r\n    callstack.startNewEvent('nonundoable');\r\n    action();\r\n    callstack.startNewEvent(eventType);\r\n  };\r\n\r\n  preLinkMarker.prototype.handleMarkText = function (context) {\r\n    const editorInfo = context.editorInfo;\r\n    const rep = context.rep;\r\n    const callstack = context.callstack;\r\n\r\n    // first we need to unmark any existing text, otherwise we'll have 2 text ranges marked\r\n    this.removeMarks(editorInfo, rep, callstack);\r\n\r\n    this.addMark(editorInfo, callstack);\r\n  };\r\n\r\n  preLinkMarker.prototype.handleUnmarkText = function (context) {\r\n    const editorInfo = context.editorInfo;\r\n    const rep = context.rep;\r\n    const callstack = context.callstack;\r\n\r\n    this.removeMarks(editorInfo, rep, callstack);\r\n  };\r\n\r\n  preLinkMarker.prototype.addMark = function (editorInfo, callstack) {\r\n    const eventType = callstack.editEvent.eventType;\r\n\r\n    // we don't want the text marking to be undoable\r\n    this.performNonUnduableEvent(eventType, callstack, () => {\r\n      editorInfo.ace_setAttributeOnSelection(MARK_CLASS, clientVars.userId);\r\n    });\r\n  };\r\n\r\n  preLinkMarker.prototype.removeMarks = function (editorInfo, rep, callstack) {\r\n    const eventType = callstack.editEvent.eventType;\r\n    const originalSelStart = rep.selStart;\r\n    const originalSelEnd = rep.selEnd;\r\n\r\n    // we don't want the text marking to be undoable\r\n    this.performNonUnduableEvent(eventType, callstack, () => {\r\n      // remove marked text\r\n      const padInner = $('iframe[name=\"ace_outer\"]').contents().find('iframe[name=\"ace_inner\"]');\r\n      const selector = `.${MARK_CLASS}`;\r\n      const repArr = editorInfo.ace_getRepFromSelector(selector, padInner);\r\n      // repArr is an array of reps\r\n      $.each(repArr, (index, rep) => {\r\n        editorInfo.ace_performSelectionChange(rep[0], rep[1], true);\r\n        editorInfo.ace_setAttributeOnSelection(MARK_CLASS, false);\r\n      });\r\n\r\n      // make sure selected text is back to original value\r\n      editorInfo.ace_performSelectionChange(originalSelStart, originalSelEnd, true);\r\n    });\r\n  };\r\n\r\n  // we do nothing on callWithAce; actions will be handled on aceEditEvent\r\n  const doNothing = () => {};\r\n\r\n  const init = (ace) => new preLinkMarker(ace);\r\n\r\n  return {\r\n    MARK_CLASS,\r\n    init,\r\n  };\r\n})();\r\n","'use strict'\r\n\r\nconst shared = (() => {\r\n  const collectContentPre = (hook, context) => {\r\n    const link = /(?:^| )(lc-[A-Za-z0-9]*)/.exec(context.cls);\r\n    const fakeLink = /(?:^| )(fakelink-[A-Za-z0-9]*)/.exec(context.cls);\r\n\r\n    if (link && link[1]) {\r\n      context.cc.doAttrib(context.state, `link::${link[1]}`);\r\n    }\r\n\r\n    // a fake link is a link copied from this or another pad. To avoid conflicts\r\n    // with existing links, a fake linkId is used, so then we generate a new one\r\n    // when the link is saved\r\n    if (fakeLink) {\r\n      const mapFakeLinks = pad.plugins.ep_full_hyperlinks.getMapfakeLinks();\r\n      const fakeLinkId = fakeLink[1];\r\n      const linkId = mapFakeLinks[fakeLinkId];\r\n      context.cc.doAttrib(context.state, `link::${linkId}`);\r\n    }\r\n\r\n    return [];\r\n  };\r\n\r\n  const generateLinkId = function () {\r\n    const linkId = `lc-${randomString(16)}`;\r\n    return linkId;\r\n  };\r\n\r\n  return {\r\n    collectContentPre,\r\n    generateLinkId,\r\n  };\r\n})();\r\n"]}